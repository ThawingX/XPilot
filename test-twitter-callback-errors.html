<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter回调错误测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            font-size: 14px;
        }
        .test-button:hover {
            background: #1a8cd8;
        }
        .error-button {
            background: #f91880;
        }
        .error-button:hover {
            background: #e1166f;
        }
        .warning-button {
            background: #ff9500;
        }
        .warning-button:hover {
            background: #e6850e;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #1d9bf0;
            padding-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 15px;
        }
        .localStorage-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>Twitter OAuth 回调错误测试</h1>
    <p>这个页面用于测试不同的Twitter OAuth回调错误场景，帮助验证错误处理逻辑。</p>

    <div class="test-section">
        <h2>localStorage 控制</h2>
        <div class="description">控制localStorage中的OAuth数据，模拟不同的会话状态</div>
        <div class="localStorage-controls">
            <button class="test-button" onclick="setValidOAuthData()">设置有效OAuth数据</button>
            <button class="warning-button" onclick="clearOAuthData()">清除OAuth数据</button>
            <button class="test-button" onclick="setInvalidState()">设置无效State</button>
            <button class="test-button" onclick="checkOAuthData()">检查当前OAuth数据</button>
        </div>
        <div id="localStorage-status"></div>
    </div>

    <div class="test-section">
        <h2>1. Invalid State Parameter 错误</h2>
        <div class="description">模拟state参数不匹配的情况</div>
        <button class="error-button" onclick="testInvalidState()">测试无效State</button>
        <button class="error-button" onclick="testMissingState()">测试缺失State</button>
    </div>

    <div class="test-section">
        <h2>2. OAuth会话过期错误</h2>
        <div class="description">模拟localStorage中没有OAuth数据的情况</div>
        <button class="error-button" onclick="testExpiredSession()">测试会话过期</button>
    </div>

    <div class="test-section">
        <h2>3. 授权被拒绝错误</h2>
        <div class="description">模拟用户拒绝授权的情况</div>
        <button class="error-button" onclick="testAccessDenied()">测试访问被拒绝</button>
    </div>

    <div class="test-section">
        <h2>4. 参数不完整错误</h2>
        <div class="description">模拟缺少必要参数的情况</div>
        <button class="error-button" onclick="testMissingCode()">测试缺失Code</button>
        <button class="error-button" onclick="testMissingBoth()">测试缺失所有参数</button>
    </div>

    <div class="test-section">
        <h2>5. 正常成功流程</h2>
        <div class="description">模拟正常的授权成功流程（需要先设置有效OAuth数据）</div>
        <button class="test-button" onclick="testSuccessFlow()">测试成功流程</button>
    </div>

    <script>
        // OAuth数据管理
        function setValidOAuthData() {
            const state = 'test_state_' + Math.random().toString(36).substring(7);
            const codeVerifier = 'test_verifier_' + Math.random().toString(36).substring(7);
            localStorage.setItem('twitter_oauth_state', state);
            localStorage.setItem('twitter_code_verifier', codeVerifier);
            updateLocalStorageStatus();
            alert('已设置有效OAuth数据');
        }

        function clearOAuthData() {
            localStorage.removeItem('twitter_oauth_state');
            localStorage.removeItem('twitter_code_verifier');
            updateLocalStorageStatus();
            alert('已清除OAuth数据');
        }

        function setInvalidState() {
            localStorage.setItem('twitter_oauth_state', 'invalid_state');
            localStorage.setItem('twitter_code_verifier', 'test_verifier');
            updateLocalStorageStatus();
            alert('已设置无效State数据');
        }

        function checkOAuthData() {
            updateLocalStorageStatus();
        }

        function updateLocalStorageStatus() {
            const state = localStorage.getItem('twitter_oauth_state');
            const verifier = localStorage.getItem('twitter_code_verifier');
            const status = document.getElementById('localStorage-status');
            status.innerHTML = `
                <strong>当前localStorage状态:</strong><br>
                State: ${state ? '存在 (' + state.substring(0, 20) + '...)' : '不存在'}<br>
                Code Verifier: ${verifier ? '存在 (' + verifier.substring(0, 20) + '...)' : '不存在'}
            `;
        }

        // 错误测试函数
        function testInvalidState() {
            setValidOAuthData();
            const params = new URLSearchParams({
                code: 'test_code_123',
                state: 'wrong_state_parameter'
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        function testMissingState() {
            setValidOAuthData();
            const params = new URLSearchParams({
                code: 'test_code_123'
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        function testExpiredSession() {
            clearOAuthData();
            const params = new URLSearchParams({
                code: 'test_code_123',
                state: 'test_state_123'
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        function testAccessDenied() {
            setValidOAuthData();
            const params = new URLSearchParams({
                error: 'access_denied',
                error_description: 'The user denied the request'
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        function testMissingCode() {
            setValidOAuthData();
            const state = localStorage.getItem('twitter_oauth_state');
            const params = new URLSearchParams({
                state: state
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        function testMissingBoth() {
            setValidOAuthData();
            window.location.href = `/auth/twitter/direct/callback`;
        }

        function testSuccessFlow() {
            setValidOAuthData();
            const state = localStorage.getItem('twitter_oauth_state');
            const params = new URLSearchParams({
                code: 'test_success_code_123',
                state: state
            });
            window.location.href = `/auth/twitter/direct/callback?${params.toString()}`;
        }

        // 页面加载时检查localStorage状态
        window.onload = function() {
            updateLocalStorageStatus();
        };
    </script>
</body>
</html>